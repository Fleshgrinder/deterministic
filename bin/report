#!/usr/bin/env bash
set -Eeuo pipefail

format=${1:?missing required <format> argument}

readarray -d '' bins < <(printf '%s\0' build/"$format"/*/*.bin | sort -z --version-sort)
if ((${#bins[@]} == 0)); then
  echo -e "\e[31mCould not find any 'build/$format/*.bin' files to test against each other.\e[0m" >&2
  exit 1
fi

first=${bins[0]}
deterministic='ğŸ‘'
echo -e "\e[1m> Expecting \e[37m$format\e[39m:\e[0m"
xxd "$first"
echo

for bin in "${bins[@]}"; do
  version=${bin%/*}
  version=${version##*/}

  language=${bin##*/}
  language=${language%.*}

  printf '\e[1m> Testing \e[37m%s %s %s\e[0m ' "$format" "$version" "$language"
  if cmp -s "$first" "$bin"; then
    echo 'ğŸŸ¢'
  else
    deterministic='ğŸ’©'
    echo 'ğŸ”´'
    xxd "$bin"
  fi
done

echo "
    $deterministic
"
